# JavaVM実装のユビキタス言語

## クラスファイル構造関連

### ファイルフォーマット
- **クラスファイル（Class File）**: Javaバイトコードを含むバイナリファイル。`.class`拡張子を持つ。
- **マジックナンバー（Magic Number）**: クラスファイルの先頭4バイト（`0xCAFEBABE`）。ファイルの識別に使用。
- **バージョン情報（Version Information）**: クラスファイルのバージョンを示す2つの数値。
  - **マイナーバージョン（Minor Version）**: 下位互換性のための番号
  - **メジャーバージョン（Major Version）**: 主要な互換性変更を示す番号

### データ型
- **u1**: 1バイトの符号なし整数
- **u2**: 2バイトの符号なし整数
- **u4**: 4バイトの符号なし整数
- **u8**: 8バイトの符号なし整数

### 定数プール
- **定数プール（Constant Pool）**: クラスファイル内の文字列や型情報などを格納するテーブル
- **定数プールカウント（Constant Pool Count）**: 定数プール内のエントリ数 + 1
- **CONSTANT_Utf8**: UTF-8エンコードされた文字列情報
- **CONSTANT_Class**: クラスまたはインターフェースの参照
- **CONSTANT_NameAndType**: フィールドまたはメソッドの名前と型情報

### アクセス制御
- **アクセスフラグ（Access Flags）**: クラス、メソッド、フィールドのアクセス制御情報
  - **public**: `0x0001`
  - **private**: `0x0002`
  - **protected**: `0x0004`
  - **static**: `0x0008`
  - **final**: `0x0010`

## 実行エンジン関連

### メモリ領域
- **スタックフレーム（Stack Frame）**: メソッド実行時の状態を保持する領域
- **オペランドスタック（Operand Stack）**: 命令の操作対象となるデータを格納するスタック
- **ローカル変数領域（Local Variables）**: メソッド内のローカル変数を格納する配列

### バイトコード命令体系

#### 命令の基本構造
- **オペコード（Opcode）**: 1バイトの命令コード
- **オペランド（Operand）**: 命令の追加パラメータ（可変長）
- **スタック効果表記**:
  - `...`: 変更されないスタック部分
  - `→`: 実行前から実行後への変化
  - `[empty]`: 空のスタック
  - 例: `..., value1, value2 → ..., result`

#### ロード・ストア命令
- **iload**: ローカル変数からint値をロード
  - **iload_<n>**: 最適化されたローカル変数ロード（n=0-3）
  - フォーマット: `iload <index>` または `iload_<n>`
  - スタック効果: `... → ..., value`

- **istore**: ローカル変数にint値をストア
  - **istore_<n>**: 最適化されたローカル変数ストア（n=0-3）
  - フォーマット: `istore <index>` または `istore_<n>`
  - スタック効果: `..., value → ...`

#### 定数ロード命令
- **iconst**: int定数をスタックにプッシュ
  - **iconst_<n>**: 最適化された定数ロード（n=-1-5）
  - フォーマット: `iconst_<n>`
  - スタック効果: `... → ..., <n>`

- **bipush**: byte値をint値としてプッシュ
  - フォーマット: `bipush <byte>`
  - スタック効果: `... → ..., value`

- **sipush**: short値をint値としてプッシュ
  - フォーマット: `sipush <byte1> <byte2>`
  - スタック効果: `... → ..., value`

#### 算術命令
- **iadd**: int加算
  - フォーマット: `iadd`
  - スタック効果: `..., value1, value2 → ..., result`

- **isub**: int減算
  - フォーマット: `isub`
  - スタック効果: `..., value1, value2 → ..., result`

- **imul**: int乗算
  - フォーマット: `imul`
  - スタック効果: `..., value1, value2 → ..., result`

- **idiv**: int除算
  - フォーマット: `idiv`
  - スタック効果: `..., value1, value2 → ..., result`
  - 例外: `ArithmeticException`（ゼロ除算時）

#### 制御命令
- **return**: void戻り値のメソッドから戻る
  - フォーマット: `return`
  - スタック効果: なし

- **ireturn**: int値を戻り値としてメソッドから戻る
  - フォーマット: `ireturn`
  - スタック効果: `..., value → [empty]`

#### スタック操作命令
- **pop**: スタックのトップ要素を破棄
  - フォーマット: `pop`
  - スタック効果: `..., value → ...`

- **dup**: スタックのトップ要素を複製
  - フォーマット: `dup`
  - スタック効果: `..., value → ..., value, value`

#### 命令実行サイクル
1. **フェッチ（Fetch）**: 命令のオペコードを読み取る
2. **デコード（Decode）**: 命令の種類を判別
3. **オペランド取得（Operand Fetch）**: 必要なオペランドを取得
4. **実行（Execute）**: 命令を実行
5. **後処理（Write Back）**: 結果をスタックまたはローカル変数に書き込み

## 例外関連
- **ClassNotFoundException**: クラスファイルが見つからない場合の例外
- **ClassFormatError**: クラスファイルの形式が不正な場合の例外
- **UnsupportedClassVersionError**: サポートされていないバージョンの場合の例外

## テスト関連
- **テストリソース（Test Resources）**: テストで使用するクラスファイルやその他のリソース
- **テストユーティリティ（Test Utilities）**: テストをサポートするヘルパークラスやメソッド
- **バウンダリーテスト（Boundary Test）**: データ型の範囲の境界値をテストするケース
- **パフォーマンステスト（Performance Test）**: 処理速度や資源使用量をテストするケース

## コード品質
- **コードカバレッジ（Code Coverage）**: テストによってカバーされるコードの割合
- **スタイルチェック（Style Check）**: コーディング規約への準拠を確認
- **リファクタリング（Refactoring）**: 動作を変えずにコードの質を改善する作業

## 設計原則
- **単一責任の原則（SRP）**: 各クラスは単一の責任のみを持つ
- **依存関係逆転の原則（DIP）**: 高レベルのモジュールは低レベルのモジュールに依存しない
- **インターフェース分離の原則（ISP）**: クライアントは使用しないインターフェースに依存しない

## 実装規約

### 基本規約
- **TODO形式**: `// TODO: 具体的な実装タスク`の形式で記述
- **テストクラス命名**: テスト対象クラス名 + "Test"（例: `ClassFileReaderTest`）
- **パッケージ構造**: 
  - `javavm.classfile`: クラスファイル関連
  - `javavm.execution`: 実行エンジン関連
  - `javavm.memory`: メモリ管理関連

### 命令実装規約
- **命令クラス命名**: `<命令名>Instruction`（例: `IloadInstruction`）
- **実行メソッド**: `execute(Frame frame)`
- **エラーメッセージ形式**: `"<命令名>: <エラー内容>"`（例: `"iadd: stack underflow"`）

### コメント規約
- **命令説明**: 
```java
/**
 * <命令名>: <命令の説明>
 * フォーマット: <バイトコードフォーマット>
 * スタック: <スタック効果>
 */